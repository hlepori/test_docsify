# Metadata for the GUFI

## Assumptions
- The GUFI is an unaltered ISO UUID v4;   
- Generic ISO UUID v4 generation services may be provided by third parties and used by FF-ICE Participants. In other terms, an eAU consuming the FF-ICE Filing Service may therefore rely on an external third-party service for the generation of the GUFIs to be assigned to its eFPLs. 
- A need is identified/confirmed to record and exchange the time at which the GUFI was generated to support some traceability objectives and to help simplify the process for confirming a GUFI is unique over some timeframe.         
- A need is identified/confirmed to record and exchange information about the GUFI origination and assignment processes, to support investigation and resolution of issues in case of e.g. GUFI collisions or multiple GUFI assignments to the same flight.

> Note: Recording and exchanging information about the GUFI origination AND assignment processes is considered important because for instance a GUFI could be rightfully originated by a trusted third-party service but still illegitimately assigned to the flight by an organisation.

## Leveraging the ISO 19115 standard 
The ISO 19115-1 standard defines the schema required for describing geographic information and services by means of metadata. It provides information about the identification, the extent, the quality, the spatial and temporal aspects, the content, the spatial reference, the portrayal, distribution, and other properties of digital geographic data and services.

The ISO 19115-1 defines in particular `Lineage` data structures that support the provision of metadata concerning the sources and production processes used in producing a resource. These data structures may be considered for exchanging information about the sources and production processes used in producing the GUFI, in line with the candidate requirements above.

## Mapping the metadata requirements for GUFI to ISO 19115 data structures
- `LI_ProcessStep.description` may store the name of GUFI production process step that is being considered, for instance `GUFI Generation` or `GUFI Assigmment`.
   - Guidance would be needed to ensure harmonised encoding of the property 
- `LI_ProcessStep.stepDateTime` may store the GUFI creation timestamp, for the `GUFI Generation` step.
- `LI_ProcessStep.processor` may store 
   - the name of the organisation that has generated the GUFI. When the GUFI generation is "delegated" to a third-party service, the name of the provider of that service would be populated.
   - the name of the organisation that has assigned the GUFI to the flight.
- `LI_ProcessStep.source` may store information about the third-party GUFI generation service being used, when the GUFI generation is "delegated".

## Examples of encoding of GUFI metadata in FIXM

### General approach
- Do not import the ISO 19115 schema that is known for its complexity (i.e. self-references) which make it complex to implement.
- Instead, mimic the relevant ISO 19115 data structures into the Base package of FIXM (xmlns:fb="http://www.fixm.aero/base/4.3"). This approach is similar to what is already done by FIXM: mimicking the GML structure for point, and mimicking the xlink:href structure.     
- Preserve the ISO 19115 semantics, in order to ensure semantic alignement of FIXM with this ISO standard and the AIRM (the AIRM uses ISO 19115).  

### Scenario 1
The name of the eAU is `My Airline`. The eAU runs its own flight planning systems (i.e. does not use the services from a CFSP). No third-party service is used for the generation of the GUFI. The GUFI is generated by the eAU `My Airline` and also assigned by `My Airline` when creating the first Filed Flight Plan or Preliminary Flight Plan for a given flight.

```xml
<fb:processStep>
  <fb:description>GUFI Generation</fb:description>
  <fb:processor>
    <fb:organisationName>My Airline</fb:organisationName>
  </fb:processor>
  <fb:stepDateTime>2021-01-01T00:00:00Z</fb:stepDateTime>
</fb:processStep>
<fb:processStep>
  <fb:description>GUFI Assignment</fb:description>
  <fb:processor>
    <fb:organisationName>My Airline</fb:organisationName>
  </fb:processor>
  <fb:stepDateTime>2021-01-01T00:01:00Z</fb:stepDateTime>
</fb:processStep>
```
 
### Scenario 2
The name of the eAU is `My Airline`. The eAU uses the services from a CFSP called `My CFSP`. No third-party service is used for the generation of the GUFI. The GUFI is generated by the CFSP `My CFSP` and also assigned by `My CFSP` when creating the first Filed Flight Plan or Preliminary Flight Plan for a given flight.

```xml
<fb:processStep>
  <fb:description>GUFI Generation</fb:description>
  <fb:processor>
    <fb:organisationName>My CFSP</fb:organisationName>
  </fb:processor>
  <fb:stepDateTime>2021-01-01T00:00:00Z</fb:stepDateTime>
</fb:processStep>
<fb:processStep>
  <fb:description>GUFI Assignment</fb:description>
  <fb:processor>
    <fb:organisationName>My CFSP</fb:organisationName>
  </fb:processor>
  <fb:stepDateTime>2021-01-01T00:01:00Z</fb:stepDateTime>
</fb:processStep>
```

### Scenario 3
The name of the eAU is `My Airline`. The eAU runs its own flight planning systems (i.e. does not use the services from a CFSP). A third-party service is used for the generation of the GUFI. The name of the service is `UUID Generation Service` and it is provided by the organisation called `My Support Organisation`. The overview of this third-party service  is available at the url `https://eur-registry.swim.aero/services/uuid_generation_service`.

```xml
<fb:processStep>
  <fb:description>GUFI Generation</fb:description>
  <fb:processor>
    <fb:organisationName>My Support Organisation</fb:organisationName>
  </fb:processor>	
  <fb:source>
    <fb:sourceCitation>
      <fb:onlineResource>
        <fb:linkage>https://eur-registry.swim.aero/services/uuid_generation_service</fb:linkage>
        <fb:name>UUID Generation Service</fb:name>
      </fb:onlineResource>
    </fb:sourceCitation>
  </fb:source>
  <fb:stepDateTime>2021-01-01T00:00:00Z</fb:stepDateTime>
</fb:processStep>
<fb:processStep>
  <fb:description>GUFI Assignment</fb:description>
  <fb:processor>
    <fb:organisationName>My Airline</fb:organisationName>
  </fb:processor>
  <fb:stepDateTime>2021-01-01T00:01:00Z</fb:stepDateTime>
</fb:processStep>	
```

## Where to encode the GUFI metadata in FIXM

### OPTION 1: generic `flightMetadata` property
Use a generic property called `flightMetadata` defined under `fx:Flight`. This property would be of type `Metadata`, which would mimic the ISO 19115 `MD_Metadata` data element.   

Applied to Scenario 1 above, the resulting encoding would look like this: 
```xml
<ffice:FficeMessage xmlns:ffice="http://www.fixm.aero/app/ffice/1.1" xmlns:fx="http://www.fixm.aero/flight/4.3" xmlns:fb="http://www.fixm.aero/base/4.3">
  <ffice:flight>
    <fx:flightMetadata>
      <fb:resourceLineage>
        <fb:processStep>
          <fb:description>GUFI Generation</fb:description>
            <fb:processor>
              <fb:organisationName>My Airline</fb:organisationName>
            </fb:processor>
          <fb:stepDateTime>2021-01-01T00:00:00Z</fb:stepDateTime>
        </fb:processStep>
        <fb:processStep>
          <fb:description>GUFI Assignment</fb:description>
        <fb:processor>
          <fb:organisationName>My Airline</fb:organisationName>
        </fb:processor>
          <fb:stepDateTime>2021-01-01T00:01:00Z</fb:stepDateTime>
        </fb:processStep>
      </fb:resourceLineage>
    </fx:flightMetadata>
    <fx:gufi codeSpace="urn:uuid">2b1bf9a9-c516-46be-bdc9-4926d9b84c8e</fx:gufi>
  </ffice:flight>	
  <ffice:type>FILED_FLIGHT_PLAN</ffice:type>
</ffice:FficeMessage>
```
|Pros|Cons|
|:-|:-|
|Scalable design that could support the exchange of additional flight metadata as new needs are identified. Also consistent with the AIM domain that defines metadata at the level of the dataset/feature, not at the level of properties| Because the metadata construct would be generically defined for Flight, it may be more difficult to enforce cardinalities or constraint some values for the specific case of the GUFI.|

### OPTION 2: specific `gufiLineage` property
Use a specific property called `gufiLineage` defined under `fx:Flight`. This property would be of type `Lineage`, which would mimic the ISO 19115 `LI_Lineage` data element. 

Applied to Scenario 1 above, the resulting encoding would look like this:
```xml
<ffice:FficeMessage xmlns:ffice="http://www.fixm.aero/app/ffice/1.1" xmlns:fx="http://www.fixm.aero/flight/4.3" xmlns:fb="http://www.fixm.aero/base/4.3">
  <ffice:flight>
    <fx:gufi codeSpace="urn:uuid">2b1bf9a9-c516-46be-bdc9-4926d9b84c8e</fx:gufi>
    <fx:gufiLineage>
      <fb:processStep>
        <fb:description>GUFI Generation</fb:description>
        <fb:processor>
          <fb:organisationName>My Airline</fb:organisationName>
        </fb:processor>
        <fb:stepDateTime>2021-01-01T00:00:00Z</fb:stepDateTime>
      </fb:processStep>
      <fb:processStep>
        <fb:description>GUFI Assignment</fb:description>
        <fb:processor>
          <fb:organisationName>My Airline</fb:organisationName>
        </fb:processor>
        <fb:stepDateTime>2021-01-01T00:01:00Z</fb:stepDateTime>
      </fb:processStep>
    </fx:gufiLineage>
  </ffice:flight>
  <ffice:type>FILED_FLIGHT_PLAN</ffice:type>
</ffice:FficeMessage>
```
|Pros|Cons|
|:-|:-|
|Easier to contrain the list of values e.g. for processStep.description (using a codelist), and possibly to enforce some cardinalities. | Not as scalable. If new needs for flight metdata are identified, this design may not be able to accomodate new items. Not fully consistent with AIM domain.|

# Alternative

It has been stated by system developers that adding new fields generally increases the complexity of the implementation as these new fields would need to be modelled again and again in client systems (i.e. primary keys on database, unique indexes, [in Europe] ADEXP for intra system communication). An alternative that may be considered could be to leverage the information already present in the eFPL, e.g. the aircraft identification, for tracing where the UUID has been misused. The benefits of the approach would be that it re-uses information and techniques in use today in terms of association. Actually, Appendix F "Association Checks" of the FF-ICE/R1 Implementation Guidance Manual already provides guidance for determining if a received flight plan (with a unique GUFI) is in fact the same as an existing one (even with a different GUFI) and lists the key fields to be processed in this context: acid, adep, ades, eobt and total estimated off block time.

With the above in mind, the following could be therefore envisaged:
- the UUID v4 could be explicitly paired in FIXM with the aircraft identification already present in the eFPL. This would also reduce the problem space for collisions to only 
those GUFIs generated with the same aircraft identification. To do so, the FIXM concept of Flight Identification, which is currently restricted to Aircraft Identification, could be extended in order to bring in the UUID v4, so that both are explicitly paired. 

```xml
<fx:flight>
  <fx:flightIdentifier>
    <fx:aircraftIdentification>AFR3041</fx:aircraftIdentification>
    <fx:gufi codeSpace="urn:uuid">2b1bf9a9-c516-46be-bdc9-4926d9b84c8e</fx:gufi>
  </fx:flightIdentifier>  
</fx:flight>
```   

- the eobt already present in the eFPL could be used to help simplify the process for confirming a GUFI is unique over some timeframe.
